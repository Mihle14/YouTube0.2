<div class="min-h-screen bg-black text-white px-4 md:px-12 py-8 flex justify-center">
  <div class="flex flex-col md:flex-row gap-8 w-full max-w-[1280px] md:ml-60">
    <div class="flex-1 max-w-3xl">

      <div class="flex justify-end gap-4 mb-4">
        <%= link_to edit_post_path(@post),
            class: "px-4 py-2 rounded-md bg-gray-700 text-white hover:bg-gray-600 transition font-medium flex items-center gap-2" do %>
          <i class="fas fa-pencil-alt"></i> Edit
        <% end %>

        <%= button_to post_path(@post),
            method: :delete,
            data: { confirm: 'Are you sure?' },
            class: "px-4 py-2 rounded-md bg-gray-700 text-white hover:bg-gray-600 transition font-medium flex items-center gap-2" do %>
          <i class="fas fa-trash"></i> Delete
        <% end %>
      </div>

      <div class="w-full mb-4">
        <% if @post.video.attached? %>
          <video controls class="w-full rounded-xl shadow-lg">
            <source src="<%= url_for(@post.video) %>" type="<%= @post.video.content_type %>">
            Your browser does not support the video tag.
          </video>
        <% elsif @post.image.attached? %>
          <%= image_tag @post.image, class: "w-full rounded-xl shadow-lg" %>
        <% end %>
      </div>
      
      <h1 class="text-2xl md:text-3xl font-bold mb-2"><%= @post.title %></h1>
      <p class="text-gray-400 mb-4">Views: <%= @post.views %></p>


      <%= link_to channel_path(@post.user.channel), class: "flex items-center gap-3" do %>
        <div>
          <% if @post.user.channel.avatar.attached? %>
            <%= image_tag @post.user.channel.avatar.variant(resize_to_fill: [48, 48]),
                class: "w-12 h-12 rounded-full object-cover" %>
          <% else %>
            <%= image_tag "https://via.placeholder.com/48",
                class: "w-12 h-12 rounded-full object-cover" %>
          <% end %>
        </div>

        <div class="flex flex-col">
          <span class="text-white font-semibold text-lg">
            <%= @post.user.channel.name %>
          </span>
          <span class="text-gray-400 text-sm">
            <%= pluralize(@post.user.channel.subscribers.count, 'subscriber') %>
          </span>
        </div>
      <% end %>

      <div class="flex items-center justify-between mb-4">
        <div></div>
        <div class="flex items-center bg-[#272727] rounded-full overflow-hidden border border-[#3f3f3f]">
            <%= render "posts/reactions", post: @post %>
            <%= render "posts/reaction_buttons", post: @post %>
        </div>
      </div>

      <div class="bg-[#0f0f0f] p-4 rounded-xl mb-6 border border-gray-800">
        <p class="text-gray-300 whitespace-pre-line"><%= @post.description %></p>
      </div>


      <div class="bg-[#0f0f0f] p-4 rounded-lg border border-gray-800">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-white font-semibold text-lg">
            Comments (<span id="comments_count"><%= @post.comments.count %></span>)
          </h2>
        </div>

        <% if user_signed_in? %>
          <div class="flex gap-3 mb-4">
            <div class="mt-1">
              <div class="w-10 h-10 rounded-full bg-gray-700 text-white flex items-center justify-center font-bold">
                <%= current_user.email.first.upcase %>
              </div>
            </div>

            <div class="flex-1">
              <%= form_with model: [@post, Comment.new], local: false, id: "new-comment-form" do |f| %>
                <%= f.text_area :body, rows: 2,
                      placeholder: "Add a public comment...",
                      class: "w-full p-3 rounded-lg bg-[#131313] text-white border border-gray-800 text-sm" %>
                <div class="flex justify-end mt-2">
                  <%= f.submit "Comment", class: "px-3 py-1 rounded-lg bg-gray-700 text-white hover:bg-gray-600 text-sm" %>
                </div>
              <% end %>
            </div>
          </div>
        <% else %>
          <p class="text-gray-400 text-sm mb-4">Please <%= link_to "sign in", new_user_session_path, class: "underline" %> to comment.</p>
        <% end %>

        <div id="comments" class="divide-y divide-gray-800">
          <%= turbo_frame_tag "comments" do %>
            <%= render @post.comments.where(parent_id: nil).order(created_at: :desc) %>
          <% end %>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  document.addEventListener("click", function(e) {
    const toggle = e.target.closest("[data-reply-toggle]");
    if (!toggle) return;

    e.preventDefault();
    const id = toggle.getAttribute("data-reply-toggle");
    const form = document.getElementById("reply-form-" + id);
    if (!form) return;
    form.classList.toggle("hidden");
    if (!form.classList.contains("hidden")) {
      const input = form.querySelector("input[type='text'], textarea");
      if (input) input.focus();
    }
  });
</script>
